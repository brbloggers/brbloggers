+++
title = "S√£o Paulo e o problema da mochila"
date = "2017-08-12 11:07:31"
categories = ["curso-r"]
original_url = "http://curso-r.com/blog/2017/08/12/2017-04-10-sao-paulo/"
+++

<p>
S√£o Paulo √© a minha cidade preferida. N√£o s√≥ porque moro aqui, mas
tamb√©m porque √© uma cidade cheia de diversidade, boa gastronomia e
oportunidades. Para sentir um pouco dessa <em>vibe</em>, recomendo
passear na avenida Paulista aos domingos. √â sensacional!
</p>
<p>
Mas a cidade da diversidade s√≥ √© o que √© porque temos muita, muita gente
nela. O munic√≠pio tem 12 milh√µes de habitantes. Esse n√∫mero √© t√£o grande
que temos um paulistano para cada 17 brasileiros! Se S√£o Paulo fosse um
pa√≠s,
<a href="https://en.wikipedia.org/wiki/List_of_countries_and_dependencies_by_population">seria
o 77 do mundo</a>, ganhando de pa√≠ses como a B√©lgica, Gr√©cia, Portugal,
Bol√≠via e muitas outras.
</p>
<p>
Outro dia eu estava pensando na seguinte problem√°tica: qual √© a √°rea do
Brasil ocupada pela popula√ß√£o de S√£o Paulo? Ou seja, se pegarmos os
munic√≠pios com grandes √°reas, quanto do pa√≠s conseguir√≠amos preencher
com 12 milh√µes de habitantes?
</p>
<p>
O interessante √© que essa quest√£o recai exatamente no <em>problema da
mochila</em>, que √© um famoso desafio de programa√ß√£o inteira. Depois de
<a href="https://en.wikipedia.org/wiki/Knapsack_problem">estudar
profundamente no wikipedia</a> (üòÖ), vi que o problema n√£o √© t√£o trivial
como parece.
</p>
<p>
Considere o seguinte contexto: voc√™ tem uma mochila com capacidade de
15kg e precisa carregar a combina√ß√£o de itens com maior valor, com cada
item possuindo valores e pesos diferentes.
</p>
<span id="fig:unnamed-chunk-2"></span>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fd/Knapsack.svg/250px-Knapsack.svg.png" alt="Knapsack problem. Retirado do [Wikipedia](https://en.wikipedia.org/wiki/Knapsack_problem#/media/File:Knapsack.svg).">
<p class="caption">
Figure 1: Knapsack problem. Retirado do
<a href="https://en.wikipedia.org/wiki/Knapsack_problem#/media/File:Knapsack.svg">Wikipedia</a>.
</p>

<p>
Outra forma de pensar nesse problema √© com um card√°pio de restaurante:
</p>
<span id="fig:unnamed-chunk-3"></span>
<img src="https://imgs.xkcd.com/comics/np_complete.png" alt="XKCD sobre o knapsack problem.">
<p class="caption">
Figure 2: XKCD sobre o knapsack problem.
</p>

<p>
Em linguagem matem√°tica, o que temos √© a task:
</p>
<p>
<span class="math display">
$$
\\begin{aligned}
&amp; \\text{maximizar } \\sum\_{i=1}^n v\_i x\_i \\\\ &amp; \\text{sujeito &\#xE0; } \\sum\_{i=1}^n w\_i x\_i \\leq W, \\text{ com } x\_i \\in\\{0,1\\}\\\\ \\end{aligned}
$$
</span>
</p>
<p>
No nosso caso essas letras significam isso aqui:
</p>
<ul>
<li>
<span class="math inline">*n*</span> √© o n√∫mero de munic√≠pios no Brasil
(5570).
</li>
<li>
<span class="math inline">*v*<sub>*i*</sub></span> √© a √°rea do munic√≠pio
<span class="math inline">*i*</span>.
</li>
<li>
<span class="math inline">*w*<sub>*i*</sub></span> √© a popula√ß√£o do
munic√≠pio <span class="math inline">*i*</span>.
</li>
<li>
<span class="math inline">*W*</span> √© a popula√ß√£o de S√£o Paulo (12
milh√µes).
</li>
<li>
<span
class="math inline">*x*‚ÄÑ=‚ÄÑ(*x*<sub>1</sub>,‚ÄÜ‚Ä¶,‚ÄÜ*x*<sub>*n*</sub>)<sup>‚ä§</sup></span>
√© o vetor que seleciona os munic√≠pios. Se o munic√≠pio <span
class="math inline">*i*</span> faz parte da solu√ß√£o <span
class="math inline">*x*<sub>*i*</sub>‚ÄÑ=‚ÄÑ1</span> e, caso contr√°rio,
<span class="math inline">*x*<sub>*i*</sub>‚ÄÑ=‚ÄÑ0</span>.
</li>
</ul>
<p>
Ou seja, queremos escolher munic√≠pios para colocar na mochila tentando
maximizar a √°rea, mas o m√°ximo de popula√ß√£o que podemos contemplar √© 12
milh√µes.
</p>
<p>
O problema da mochila √© muito interessante pois trata-se de um problema
NP-dif√≠cil, ou seja, n√£o existe um algoritmo de polinomial capaz de
resolv√™-lo. Se <span
class="math inline">$w\_i &gt; 0, \\forall i\\in1,\\dots,n$</span> ent√£o
a solu√ß√£o pode ser encontrada com um algoritmo pseudo-polinomial.
</p>
<p>
Se <span class="math inline">*x*<sub>*i*</sub></span> pudesse assumir
valores entre zero e um (ou seja, se pud√©ssemos selecionar apenas
peda√ßos de munic√≠pios), a solu√ß√£o seria trivial. Bastaria colocar os
munic√≠pios em ordem decrescente pela raz√£o <span
class="math inline">*v*<sub>*i*</sub>/*w*<sub>*i*</sub></span> e
escolher os munic√≠pios ou parte deles at√© obter <span
class="math inline">*W*</span>.
</p>
<p>
Isso indica uma forma sub-√≥tima de resolver o problema. Chamamos essa
solu√ß√£o de ad-hoc. A solu√ß√£o √© encontrada assim:
</p>
<ol>
<li>
Colocar os munic√≠pios em ordem decrescente pela raz√£o <span
class="math inline">*v*<sub>*i*</sub>/*w*<sub>*i*</sub></span>,
</li>
<li>
Escolher os munic√≠pios de maior raz√£o at√© que a popula√ß√£o do pr√≥ximo
munic√≠pio estoure <span class="math inline">*W*</span>.
</li>
<li>
Escolher outros munic√≠pios com maior raz√£o na ordem at√© n√£o ser poss√≠vel
incluir mais nenhum munic√≠pio.
</li>
</ol>

<p>
A solu√ß√£o √≥tima pode ser encontrada usando a fun√ß√£o
<code>mknapsack()</code> do pacote <code>adagio</code>. Por exemplo,
considere os vetores de pesos <code>w</code>, valores <code>p</code> e
m√°ximo <code>cap</code> abaixo.
</p>
<pre class="r"><code>p &lt;- c(15, 100, 90, 60, 40, 15, 10, 1)
w &lt;- c( 2, 20, 20, 30, 40, 30, 60, 10)
cap &lt;- 102</code></pre>
<p>
O vetor-solu√ß√£o √© dado por
</p>
<pre class="r"><code>is &lt;- adagio::mknapsack(p, w, cap)
is$ksack
## [1] 1 1 1 1 0 1 0 0</code></pre>

<p>
As √°reas e estimativas das popula√ß√µes dos munic√≠pios do Brasil em 2016
foram obtidas do IBGE. A leitura √© realizada usando pacotes do
<code>tidyverse</code>.
</p>
<p>
<strong>Pacotes:</strong>
</p>
<pre class="r"><code>library(tidyverse)
library(janitor)
library(readxl)
library(httr)</code></pre>
<p>
<strong>√Åreas:</strong>
</p>
<pre class="r"><code>url_area &lt;- paste0( &apos;ftp://geoftp.ibge.gov.br&apos;, &apos;/organizacao_do_territorio/estrutura_territorial/areas_territoriais/2016/&apos;, &apos;AR_BR_RG_UF_MUN_2016.xls&apos;
) %&gt;% GET(write_disk(&apos;area.xls&apos;, overwrite = TRUE)) area &lt;- read_excel(&apos;area.xls&apos;) %&gt;% clean_names() %&gt;% filter(!is.na(id)) %&gt;% select(uf = nm_uf_sigla, cd_gcmun, muni = nm_mun_2016, area = ar_mun_2016)</code></pre>
<p>
<strong>Popula√ß√£o:</strong>
</p>
<pre class="r"><code>url_pop &lt;- paste0( &apos;ftp://ftp.ibge.gov.br&apos;, &apos;/Estimativas_de_Populacao/Estimativas_2016/&apos;, &apos;estimativa_TCU_2016_20170614.xls&apos;
) %&gt;% GET(write_disk(&apos;pop.xls&apos;, overwrite = TRUE)) loc &lt;- locale(grouping_mark = &apos;.&apos;, decimal_mark = &apos;,&apos;)
pop &lt;- read_excel(&apos;pop.xls&apos;, skip = 1, sheet = 2) %&gt;% clean_names() %&gt;% filter(!is.na(cod_munic)) %&gt;% mutate(pop = parse_number(`popula&#xE7;&#xE3;o_estimada`, locale = loc), cd_gcmun = paste0(cod_uf, cod_munic)) %&gt;% select(cd_gcmun, pop)</code></pre>
<p>
Para completar, temos os shapefiles dos munic√≠pios. Os originais foram
baixados
<a href="ftp://geoftp.ibge.gov.br/organizacao_do_territorio/malhas_territoriais/malhas_municipais/municipio_2016/Brasil/BR/">nesse
link</a>, mas fiz um c√≥digo para reduzir a resolu√ß√£o e preferi omitir do
post. Se quiser ver, entre no
<a href="https://github.com/curso-r/site">reposit√≥rio que gera esse
site</a>. Para ler os shapes usamos o pacote <code>sf</code>:
</p>
<p>
No final, vamos dar um join das tabelas:
</p>
<pre class="r"><code>dados &lt;- area %&gt;% left_join(pop, &apos;cd_gcmun&apos;) %&gt;% mutate(razao = area / pop) %&gt;% filter(!is.na(pop))</code></pre>

<p>
A solu√ß√£o ad-hoc e √≥tima s√£o computadas com esse c√≥digo:
</p>
<pre class="r"><code>d_solucao &lt;- dados %&gt;% arrange(desc(razao)) %&gt;% # ordena para solucao adhoc funcionar mutate(area2 = as.integer(area * 1000), # necessario para mknapsack funcionar s_knapsack = adagio::mknapsack(area2, pop, max(pop))$ksack, acu = cumsum(pop), s_adhoc0 = if_else(acu &lt; max(pop), 1, 0), s_adhoc = s_adhoc0) </code></pre>
<p>
Agora, vamos melhorar a solu√ß√£o ad-hoc incluindo os melhores munic√≠pios.
</p>
<pre class="r"><code>id_melhor &lt;- 0
pop_faltam &lt;- with(d_solucao, max(pop) - sum(s_adhoc0 * pop))
while (is.na(id_melhor)) { # pega id do melhor municipio a ser incluido id_melhor &lt;- with(d_solucao, which(pop &lt;= pop_faltam &amp; s_adhoc == 0)[1]) if (is.na(id_melhor)) { d_solucao$s_adhoc[id_melhor] &lt;- 1 pop_faltam &lt;- with(d_solucao, max(pop) - sum(s_adhoc * pop)) }
}</code></pre>
<p>
A Tabela
<a href="http://curso-r.com/blog/2017/08/12/2017-04-10-sao-paulo/#tab:dif">1</a>
mostra os munic√≠pios que foram classificados diferentemente nos dois
m√©todos. Note que a solu√ß√£o √≥tima trocou apenas um munic√≠pio da solu√ß√£o
adhoc (Nova Aurora - GO) pelo munic√≠pio de Monte Alegre de Minas - MG.
</p>
<pre class="r"><code>d_solucao %&gt;% filter(s_adhoc != s_knapsack) %&gt;% select(uf, muni, area, pop, s_adhoc, s_knapsack) %&gt;% knitr::kable(caption = &apos;Munic&#xED;pios diferentes nas duas solu&#xE7;&#xF5;es.&apos;)</code></pre>
<table>
<caption>
<span id="tab:dif">Table 1: </span>Munic√≠pios diferentes nas duas
solu√ß√µes.
</caption>
<thead>
</thead>
<tbody>
<tr class="odd">
<td>
GO
</td>
<td>
NOVA AURORA
</td>
<td>
302.655
</td>
<td>
2194
</td>
<td>
1
</td>
<td>
0
</td>
</tr>
<tr class="even">
<td>
MG
</td>
<td>
MONTE ALEGRE DE MINAS
</td>
<td>
2595.957
</td>
<td>
20979
</td>
<td>
0
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
<p>
A Tabela
<a href="http://curso-r.com/blog/2017/08/12/2017-04-10-sao-paulo/#tab:dif2">2</a>
mostra a diferen√ßa dos resultados dos dois m√©todos. A solu√ß√£o √≥tima fica
com apenas 92 pessoas a menos que S√£o Paulo.
</p>
<table>
<caption>
<span id="tab:dif2">Table 2: </span>Diferen√ßa dos resultados.
</caption>
<thead>
</thead>
<tbody>
<tr class="odd">
<td>
adhoc
</td>
<td>
5576985.742
</td>
<td>
12019298
</td>
<td>
18877
</td>
</tr>
<tr class="even">
<td>
knapsack
</td>
<td>
5579279.044
</td>
<td>
12038083
</td>
<td>
92
</td>
</tr>
<tr class="odd">
<td>
S√£o Paulo
</td>
<td>
-
</td>
<td>
12038175
</td>
<td>
0
</td>
</tr>
</tbody>
</table>

<p>
Visualmente, a solu√ß√£o √≥tima e a solu√ß√£o adhoc s√£o id√™nticas. Por isso
vou mostrar apenas como fica o mapa para a solu√ß√£o √≥tima.
</p>
<p>
O resultado aparece na Figura
<a href="http://curso-r.com/blog/2017/08/12/2017-04-10-sao-paulo/#fig:final">3</a>.
√â realmente impressionante ver que aquela regi√£ozinha vermelha tem a
mesma popula√ß√£o que toda a regi√£o azul do mapa.
</p>
<span id="fig:final"></span>
<img src="https://raw.githubusercontent.com/curso-r/site/master/content/blog/img/mapa-final.png" alt="Mapa do Brasil final.">
<p class="caption">
Figure 3: Mapa do Brasil final.
</p>

<p>
√â isso! Happy coding ;)
</p>

